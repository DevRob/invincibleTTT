$(function(){function e(e,t,r){for(var o=[],i=0;t>i;i++){o.push([]);for(var a=0;r>a;a++)o[i].push(e)}return o}function t(e){var t=[];return e.forEach(function(r){t.push([]),r.forEach(function(o){t[e.indexOf(r)].push(o)})}),t}function r(e){return parseInt((e+1)%2)}function o(e,t,r){var o=e.checkWin(),i=Math.pow(e.dim,2)+1;return o?3==o?{score:0}:1==o?{score:r-i}:{score:i-r}:void 0}function i(e,t,a){a+=1;var n=[],s=e.getEmptySquares();if(e.checkWin())return o(e,t,a);for(var l=0,h=s.length;h>l;l++){var d=new u(e.dim,e.squares);d.move(s[l],t),n.push({score:i(d,r(t),a).score,move:s[l]})}return n.sort(function(e,t){return e.score-t.score}),0==t?n[0]:1==t?n.last():void 0}function a(){location.reload()}function n(){function e(r){var i=a.board.checkWin();l(n,i),a.drawMove(),null!=i?(a.drawMove(),3!=i&&a.drawWin(),setTimeout(function(){a.resetGame(),e()},1250)):"A.I."==a.players[a.actualPlayer].playerType?setTimeout(function(){o()},750):"Human"==a.players[a.actualPlayer].playerType&&c.addEventListener("mousedown",t)}function t(o){var i=(a.squareSize,a.getSquare(o.offsetX,o.offsetY));null===a.board.squares[i.row][i.col]&&(a.board.move([i.row,i.col],a.actualPlayer),a.actualPlayer=r(a.actualPlayer),c.removeEventListener("mousedown",t),e())}function o(){var t={};t=a.board.getEmptySquares().length>=Math.pow(a.board.dim,2)?{score:10,move:Math.randomChoice(a.board.getEmptySquares())}:i(a.board,a.actualPlayer,0),a.board.move(t.move,a.actualPlayer),a.actualPlayer=r(a.actualPlayer),e()}var a,n=[0,0,0],u=s();u&&(a=new d(u),f.style.display="none",p.style.display="block",$(".player1").text(a.players[0].playerName),$(".player2").text(a.players[1].playerName),e())}function s(){var e={boardSize:3,player1Type:$("#radio1").children(".checked").attr("data-ptype1"),player2Type:$("#radio2").children(".checked").attr("data-ptype2"),firstMove:$("#radio3").children(".checked").attr("data-firstmove")},t={boardSize:e.boardSize,player1:[e.player1Type,$("#input-4").val()],player2:[e.player2Type,$("#input-5").val()],firstMove:e.firstMove};console.log(e);for(option in e)if(!e[option])return void alert("Please set: "+option);return t}function l(e,t){e[t-1]+=1,$("#0").children("span").text(e[0]),$("#1").children("span").text(e[1]),$("#2").children("span").text(e[2])}Number.prototype.mod=function(e){return(this%e+e)%e},Array.prototype.extend=function(e){this.push.apply(this,e)},Array.prototype.last=function(){return this[this.length-1]},Math.randomChoice=function(e){return e[parseInt(Math.floor(Math.random()*e.length))]};var u=function(e,r){this.dim=e,r?this.squares=t(r):this.init()};u.prototype.init=function(){this.squares=e(null,this.dim,this.dim)},u.prototype.getEmptySquares=function(){for(var e=this.squares,t=[],r=0,o=e.length;o>r;r++)for(var i=0,a=e[r].length;a>i;i++)null===e[r][i]&&t.push([r,i]);return t},u.prototype.move=function(e,t){var r=e[0],o=e[1];null===this.squares[r][o]&&(this.squares[r][o]=t)},u.prototype.checkWin=function(){self=this,self.lines=[],self.winnerLine=null,self.gameStatus=null,self.lines.extend(self.squares);for(var e=[],t=0,r=self.dim;r>t;t++)e.push([]),self.squares.forEach(function(r){e[t].push(r[t])});self.lines.extend(e);for(var o=[],i=[],a=0,n=self.squares.length;n>a;a++)o.push(self.squares[a][a]),i.push(self.squares[a][Math.abs(a-self.squares[a].length)-1]);self.lines.push(o),self.lines.push(i);for(var t=0,s=self.lines,r=self.lines.length;r>t;t++){var l=new Set(s[t]);if(1===l.size){if(!l.has(null)){if(self.winnerLine=self.lines.indexOf(s[t]),0===s[t][0]){self.gameStatus=1;break}self.gameStatus=2;break}}else 0==self.getEmptySquares().length&&(self.gameStatus=3)}return self.gameStatus},u.prototype.logBoard=function(){var e=this.squares,t=[];console.log("-------------------"),e.forEach(function(e){e.forEach(function(e){0==e?t.push("O"):1==e?t.push("X"):t.push("-")}),console.log(t),t=[]}),console.log("-------------------")};var h=function(e){function t(e){return e?e:Math.randomChoice(["bob","tom","selly","katy","zorg"])}this.playerName=t(e[1]),this.playerType=e[0]},d=function(e){this.boardSize=e.boardSize,this.board=new u(this.boardSize),this.squareSize=c.width/this.boardSize,this.players=[new h(e.player1),new h(e.player2)],this.winner=null,this.frameSetup(),this.firstMove=e.firstMove,this.actualPlayer=this.setFirstPlayer(this.firstMove)};d.prototype.setFirstPlayer=function(){return this.firstMove>1?Math.randomChoice([0,1]):parseInt(this.firstMove)},d.prototype.frameSetup=function(){for(var e=1,t=this.boardSize;t>e;e++){lineStart=[this.squareSize*e,0],lineEnd=[this.squareSize*e,c.height];for(var r=0;2>r;r++)y.beginPath(),y.moveTo(lineStart[0],lineStart[1]),y.lineTo(lineEnd[0],lineEnd[1]),y.lineWidth=5,y.strokeStyle="#8894a0",y.stroke(),lineStart.reverse(),lineEnd.reverse()}},d.prototype.drawMove=function(){for(var e=this.board.squares,t=this.squareSize,r=0,o=e.length;o>r;r++)for(var i=0,a=e[r].length;a>i;i++)0===e[r][i]?(y.beginPath(),y.arc(this.getCoord(i),this.getCoord(r),c.width/(2*this.boardSize)*.5,0,2*Math.PI),y.strokeStyle="#626e7a",y.lineWidth=this.squareSize/10,y.stroke()):1===e[r][i]&&(y.beginPath(),y.moveTo(this.getCoord(i)+t/4,this.getCoord(r)+t/4),y.lineTo(this.getCoord(i)-t/4,this.getCoord(r)-t/4),y.moveTo(this.getCoord(i)+t/4,this.getCoord(r)-t/4),y.lineTo(this.getCoord(i)-t/4,this.getCoord(r)+t/4),y.strokeStyle="#27a8e0",y.lineCap="round",y.lineWidth=this.squareSize/10,y.stroke())},d.prototype.drawWin=function(){function e(e){var r={0:[[e,0],[e,t-1]],1:[[0,e.mod(t)],[t-1,e.mod(t)]],2:[[(e-2*t)*(t-1),0],[(e-2*t+1).mod(2)*(t-1),t-1]]};return r[parseInt(e/t)]}var t=(this.board.squares,this.squareSize,this.board.lines,parseInt(this.board.dim)),r=parseInt(this.board.winnerLine),o=e(r);this.actualPlayer;y.beginPath(),y.moveTo(this.getCoord(o[0][1]),this.getCoord(o[0][0])+12),y.lineTo(this.getCoord(o[1][1]),this.getCoord(o[1][0])-12),y.strokeStyle="#8894a0",y.lineCap="round",y.lineWidth=this.squareSize/7,y.stroke()},d.prototype.getCoord=function(e){return this.squareSize*(e+.5)},d.prototype.getSquare=function(e,t){return{row:parseInt(t/this.squareSize),col:parseInt(e/this.squareSize)}},d.prototype.resetGame=function(){this.board.init(),y.clearRect(0,0,c.width,c.height),this.setFirstPlayer(),this.frameSetup(),this.winner=null};var c=document.getElementById("canvas"),f=document.getElementById("menu"),p=document.getElementById("ingameUI"),y=c.getContext("2d"),m=.6*window.innerHeight;y.mozImageSmoothingEnabled=!0,y.msImageSmoothingEnabled=!0,y.imageSmoothingEnabled=!0,c.width=c.height=m,$(".fake-button").on("click",function(){$(this).parent(".button-bar").find("img").addClass("gray-filter"),$(this).siblings(".fake-button").removeClass("checked"),$(this).children("img").removeClass("gray-filter"),$(this).addClass("checked")}),$("#startGame").on("click",n),$("#newgame").on("click",a)});