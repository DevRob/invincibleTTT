$(function(){function e(e,t,r){for(var o=[],a=0;t>a;a++){o.push([]);for(var i=0;r>i;i++)o[a].push(e)}return o}function t(e){var t=[];return e.forEach(function(r){t.push([]),r.forEach(function(o){t[e.indexOf(r)].push(o)})}),t}function r(e){return parseInt((e+1)%2)}function o(e,t,r){var o=e.checkWin(),a=Math.pow(e.dim,2)+1;return o?3==o?{score:0}:1==o?{score:r-a}:{score:a-r}:void 0}function a(e,t,i){i+=1;var n=[],s=e.getEmptySquares();if(e.checkWin())return o(e,t,i);for(var h=0,l=s.length;l>h;h++){var d=new u(e.dim,e.squares);d.move(s[h],t),n.push({score:a(d,r(t),i).score,move:s[h]})}return n.sort(function(e,t){return e.score-t.score}),0===t?n[0]:1==t?n.last():void 0}function i(){location.reload()}function n(){function e(r){var a=i.board.checkWin();h(n,a),i.drawMove(),null!==a?(i.drawMove(),3!=a&&i.drawWin(),setTimeout(function(){i.resetGame(),e()},1250)):"A.I."==i.players[i.actualPlayer].playerType?setTimeout(function(){o()},750):"Human"==i.players[i.actualPlayer].playerType&&c.addEventListener("mousedown",t)}function t(o){var a=i.getSquare(o.offsetX,o.offsetY);null===i.board.squares[a.row][a.col]&&(i.board.move([a.row,a.col],i.actualPlayer),i.actualPlayer=r(i.actualPlayer),c.removeEventListener("mousedown",t),e())}function o(){var t={};t=i.board.getEmptySquares().length>=Math.pow(i.board.dim,2)?{score:10,move:Math.randomChoice(i.board.getEmptySquares())}:a(i.board,i.actualPlayer,0),i.board.move(t.move,i.actualPlayer),i.actualPlayer=r(i.actualPlayer),e()}var i,n=[0,0,0],u=s();u&&(i=new d(u),p.style.display="none",f.style.display="block",$(".player1").text(i.players[0].playerName),$(".player2").text(i.players[1].playerName),e())}function s(){var e={boardSize:3,player1Type:$("#radio1").children(".checked").attr("data-ptype1"),player2Type:$("#radio2").children(".checked").attr("data-ptype2"),firstMove:$("#radio3").children(".checked").attr("data-firstmove")},t={boardSize:e.boardSize,player1:[e.player1Type,$("#input-4").val()],player2:[e.player2Type,$("#input-5").val()],firstMove:e.firstMove};console.log(e);for(var r in e)if(e.hasOwnProperty(r)&&!e[r])return void alert("Please set: "+r);return t}function h(e,t){e[t-1]+=1,$("#0").children("span").text(e[0]),$("#1").children("span").text(e[1]),$("#2").children("span").text(e[2])}Number.prototype.mod=function(e){return(this%e+e)%e},Array.prototype.extend=function(e){this.push.apply(this,e)},Array.prototype.last=function(){return this[this.length-1]},Math.randomChoice=function(e){return e[parseInt(Math.floor(Math.random()*e.length))]};var u=function(e,r){this.dim=e,r?this.squares=t(r):this.init()};u.prototype.init=function(){this.squares=e(null,this.dim,this.dim)},u.prototype.getEmptySquares=function(){for(var e=this.squares,t=[],r=0,o=e.length;o>r;r++)for(var a=0,i=e[r].length;i>a;a++)null===e[r][a]&&t.push([r,a]);return t},u.prototype.move=function(e,t){var r=e[0],o=e[1];null===this.squares[r][o]&&(this.squares[r][o]=t)},u.prototype.checkWin=function(){var e=this;e.lines=[],e.winnerLine=null,e.gameStatus=null,e.lines.extend(e.squares);for(var t=[],r=0,o=e.dim;o>r;r++)t.push([]),e.squares.forEach(function(e){t[r].push(e[r])});e.lines.extend(t);for(var a=[],i=[],n=0,s=e.squares.length;s>n;n++)a.push(e.squares[n][n]),i.push(e.squares[n][Math.abs(n-e.squares[n].length)-1]);e.lines.push(a),e.lines.push(i);for(var h=0,u=e.lines,l=e.lines.length;l>h;h++){var d=new Set(u[h]);if(1===d.size){if(!d.has(null)){if(e.winnerLine=e.lines.indexOf(u[h]),0===u[h][0]){e.gameStatus=1;break}e.gameStatus=2;break}}else 0===e.getEmptySquares().length&&(e.gameStatus=3)}return e.gameStatus},u.prototype.logBoard=function(){var e=this.squares,t=[];console.log("-------------------"),e.forEach(function(e){e.forEach(function(e){0===e?t.push("O"):1==e?t.push("X"):t.push("-")}),console.log(t),t=[]}),console.log("-------------------")};var l=function(e){function t(e){return e?e:Math.randomChoice(["bob","tom","selly","katy","zorg"])}this.playerName=t(e[1]),this.playerType=e[0]},d=function(e){this.boardSize=e.boardSize,this.board=new u(this.boardSize),this.squareSize=c.width/this.boardSize,this.players=[new l(e.player1),new l(e.player2)],this.winner=null,this.frameSetup(),this.firstMove=e.firstMove,this.actualPlayer=this.setFirstPlayer(this.firstMove)};d.prototype.setFirstPlayer=function(){return this.firstMove>1?Math.randomChoice([0,1]):parseInt(this.firstMove)},d.prototype.frameSetup=function(){for(var e,t,r=1,o=this.boardSize;o>r;r++){e=[this.squareSize*r,0],t=[this.squareSize*r,c.height];for(var a=0;2>a;a++)y.beginPath(),y.moveTo(e[0],e[1]),y.lineTo(t[0],t[1]),y.lineWidth=5,y.strokeStyle="#8894a0",y.stroke(),e.reverse(),t.reverse()}},d.prototype.drawMove=function(){for(var e=this.board.squares,t=this.squareSize,r=0,o=e.length;o>r;r++)for(var a=0,i=e[r].length;i>a;a++)0===e[r][a]?(y.beginPath(),y.arc(this.getCoord(a),this.getCoord(r),c.width/(2*this.boardSize)*.5,0,2*Math.PI),y.strokeStyle="#626e7a",y.lineWidth=this.squareSize/10,y.stroke()):1===e[r][a]&&(y.beginPath(),y.moveTo(this.getCoord(a)+t/4,this.getCoord(r)+t/4),y.lineTo(this.getCoord(a)-t/4,this.getCoord(r)-t/4),y.moveTo(this.getCoord(a)+t/4,this.getCoord(r)-t/4),y.lineTo(this.getCoord(a)-t/4,this.getCoord(r)+t/4),y.strokeStyle="#27a8e0",y.lineCap="round",y.lineWidth=this.squareSize/10,y.stroke())},d.prototype.drawWin=function(){function e(e){var r={0:[[e,0],[e,t-1]],1:[[0,e.mod(t)],[t-1,e.mod(t)]],2:[[(e-2*t)*(t-1),0],[(e-2*t+1).mod(2)*(t-1),t-1]]};return r[parseInt(e/t)]}var t=parseInt(this.board.dim),r=parseInt(this.board.winnerLine),o=e(r);y.beginPath(),y.moveTo(this.getCoord(o[0][1]),this.getCoord(o[0][0])+12),y.lineTo(this.getCoord(o[1][1]),this.getCoord(o[1][0])-12),y.strokeStyle="#8894a0",y.lineCap="round",y.lineWidth=this.squareSize/7,y.stroke()},d.prototype.getCoord=function(e){return this.squareSize*(e+.5)},d.prototype.getSquare=function(e,t){return{row:parseInt(t/this.squareSize),col:parseInt(e/this.squareSize)}},d.prototype.resetGame=function(){this.board.init(),y.clearRect(0,0,c.width,c.height),this.setFirstPlayer(),this.frameSetup(),this.winner=null};var c=document.getElementById("canvas"),p=document.getElementById("menu"),f=document.getElementById("ingameUI"),y=c.getContext("2d"),m=.6*window.innerHeight;y.mozImageSmoothingEnabled=!0,y.msImageSmoothingEnabled=!0,y.imageSmoothingEnabled=!0,c.width=c.height=m,$(".fake-button").on("click",function(){$(this).parent(".button-bar").find("img").addClass("gray-filter"),$(this).siblings(".fake-button").removeClass("checked"),$(this).children("img").removeClass("gray-filter"),$(this).addClass("checked")}),$("#startGame").on("click",n),$("#newgame").on("click",i)});